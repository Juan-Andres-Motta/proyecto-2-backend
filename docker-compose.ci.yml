# Docker Compose for CI/CD Environment
# Optimized for GitHub Actions and CI pipelines
# Uses SHARED DATABASE and LocalStack

networks:
  microservices:
    driver: bridge

services:
  # Shared PostgreSQL Database
  shared-db:
    image: postgres:15-alpine
    container_name: shared-db
    environment:
      - POSTGRES_DB=medisupply
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    tmpfs:
      - /var/lib/postgresql/data
    networks:
      - microservices
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d medisupply"]
      interval: 5s
      timeout: 5s
      retries: 5

  # LocalStack - AWS Services Emulator
  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=sqs,s3,sns
      - DEBUG=0
      - LOCALSTACK_WEB_UI=0
      - PERSISTENCE=0
      - EAGER_SERVICE_LOADING=1
      - DOCKER_HOST=unix:///var/run/docker.sock
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./scripts/localstack-init.sh:/etc/localstack/init/ready.d/init.sh"
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================
  # DATABASE MIGRATIONS
  # ==========================================
  # These services run Alembic migrations on the shared database
  # They run once and exit before the main services start

  catalog-migrate:
    build:
      context: ./catalog
      target: app
    container_name: catalog-migrate
    command: poetry run alembic upgrade head
    environment:
      - DATABASE_URL=postgresql://postgres:password@shared-db:5432/medisupply
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
    depends_on:
      shared-db:
        condition: service_healthy
    networks:
      - microservices
    restart: "no"

  client-migrate:
    build:
      context: ./client
      target: app
    container_name: client-migrate
    command: poetry run alembic upgrade head
    environment:
      - DATABASE_URL=postgresql://postgres:password@shared-db:5432/medisupply
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
    depends_on:
      shared-db:
        condition: service_healthy
    networks:
      - microservices
    restart: "no"

  delivery-migrate:
    build:
      context: ./delivery
      target: app
    container_name: delivery-migrate
    command: poetry run alembic upgrade head
    environment:
      - DATABASE_URL=postgresql://postgres:password@shared-db:5432/medisupply
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
    depends_on:
      shared-db:
        condition: service_healthy
    networks:
      - microservices
    restart: "no"

  inventory-migrate:
    build:
      context: ./inventory
      target: app
    container_name: inventory-migrate
    command: poetry run alembic upgrade head
    environment:
      - DATABASE_URL=postgresql://postgres:password@shared-db:5432/medisupply
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
    depends_on:
      shared-db:
        condition: service_healthy
    networks:
      - microservices
    restart: "no"

  order-migrate:
    build:
      context: ./order
      target: app
    container_name: order-migrate
    command: poetry run alembic upgrade head
    environment:
      - DATABASE_URL=postgresql://postgres:password@shared-db:5432/medisupply
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
    depends_on:
      shared-db:
        condition: service_healthy
    networks:
      - microservices
    restart: "no"

  seller-migrate:
    build:
      context: ./seller
      target: app
    container_name: seller-migrate
    command: poetry run alembic upgrade head
    environment:
      - DATABASE_URL=postgresql://postgres:password@shared-db:5432/medisupply
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
    depends_on:
      shared-db:
        condition: service_healthy
    networks:
      - microservices
    restart: "no"

  # ==========================================
  # APPLICATION SERVICES
  # ==========================================

  # BFF Service
  bff:
    build:
      context: ./bff
    container_name: bff
    ports:
      - "8000:8000"
    environment:
      - APP_NAME=BFF Service
      - APP_VERSION=1.0.0
      - LOG_LEVEL=INFO
      - TEST_MODE=true
      - AWS_COGNITO_USER_POOL_ID=us-east-1_cipool
      - AWS_COGNITO_WEB_CLIENT_ID=ciwebclient
      - AWS_COGNITO_MOBILE_CLIENT_ID=cimobileclient
      - AWS_COGNITO_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
      - AWS_SQS_ENDPOINT_URL=http://localstack:4566
      - CATALOG_URL=http://catalog:8000
      - CLIENT_URL=http://client:8000
      - DELIVERY_URL=http://delivery:8000
      - INVENTORY_URL=http://inventory:8000
      - ORDER_URL=http://order:8000
      - SELLER_URL=http://seller:8000
      - SQS_QUEUE_URL=http://localstack:4566/000000000000/reports-queue
      - SQS_REPORTS_QUEUE_URL=http://localstack:4566/000000000000/reports-queue
      - SQS_ORDER_EVENTS_QUEUE_URL=http://localstack:4566/000000000000/medisupply-order-events-bff-queue
      - SQS_DELIVERY_ROUTES_QUEUE_URL=http://localstack:4566/000000000000/medisupply-delivery-routes-generated-queue
      - SQS_REGION=us-east-1
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/bff/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Catalog Service
  catalog:
    build:
      context: ./catalog
      target: app
    container_name: catalog
    ports:
      - "8001:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@shared-db:5432/medisupply
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
    depends_on:
      shared-db:
        condition: service_healthy
      localstack:
        condition: service_healthy
      catalog-migrate:
        condition: service_completed_successfully
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/catalog/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Client Service
  client:
    build:
      context: ./client
      target: app
    container_name: client
    ports:
      - "8002:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@shared-db:5432/medisupply
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
    depends_on:
      shared-db:
        condition: service_healthy
      localstack:
        condition: service_healthy
      client-migrate:
        condition: service_completed_successfully
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/client/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Delivery Service
  delivery:
    build:
      context: ./delivery
      target: app
    container_name: delivery
    ports:
      - "8003:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@shared-db:5432/medisupply
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
      - AWS_REGION=us-east-1
      - SQS_ORDER_EVENTS_QUEUE_URL=http://localstack:4566/000000000000/medisupply-order-events-delivery-queue
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
    depends_on:
      shared-db:
        condition: service_healthy
      localstack:
        condition: service_healthy
      delivery-migrate:
        condition: service_completed_successfully
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/delivery/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Inventory Service
  inventory:
    build:
      context: ./inventory
      target: app
    container_name: inventory
    ports:
      - "8004:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@shared-db:5432/medisupply
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
    depends_on:
      shared-db:
        condition: service_healthy
      localstack:
        condition: service_healthy
      inventory-migrate:
        condition: service_completed_successfully
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/inventory/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Order Service
  order:
    build:
      context: ./order
      target: app
    container_name: order
    ports:
      - "8005:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@shared-db:5432/medisupply
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
      - INVENTORY_SERVICE_URL=http://inventory:8000
      - CUSTOMER_SERVICE_URL=http://client:8000
      - SELLER_SERVICE_URL=http://seller:8000
      - AWS_REGION=us-east-1
      - S3_ORDER_REPORTS_BUCKET=reports-bucket
      - SQS_REPORTS_QUEUE_URL=http://localstack:4566/000000000000/reports-queue
      - SNS_ORDER_EVENTS_TOPIC_ARN=arn:aws:sns:us-east-1:000000000000:medisupply-order-events-topic
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
    depends_on:
      shared-db:
        condition: service_healthy
      localstack:
        condition: service_healthy
      order-migrate:
        condition: service_completed_successfully
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/order/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Seller Service
  seller:
    build:
      context: ./seller
      target: app
    container_name: seller
    ports:
      - "8006:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@shared-db:5432/medisupply
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
      - SQS_ORDER_EVENTS_QUEUE_URL=http://localstack:4566/000000000000/medisupply-order-events-seller-queue
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
    depends_on:
      shared-db:
        condition: service_healthy
      localstack:
        condition: service_healthy
      seller-migrate:
        condition: service_completed_successfully
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/seller/health"]
      interval: 10s
      timeout: 5s
      retries: 3
