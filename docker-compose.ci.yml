# Docker Compose for CI/CD Environment
# Optimized for GitHub Actions and CI pipelines
# Uses LocalStack for all AWS services (Cognito, SQS, S3)

networks:
  microservices:
    driver: bridge

services:
  # LocalStack - AWS Services Emulator
  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    ports:
      - "4566:4566"
    environment:
      # Core configuration
      - SERVICES=sqs,s3
      - DEBUG=0  # Disable debug for faster startup
      - LOCALSTACK_WEB_UI=0  # No Web UI in CI
      - PERSISTENCE=0  # No persistence needed in CI
      - EAGER_SERVICE_LOADING=1  # Load all services at startup
      # Docker configuration
      - DOCKER_HOST=unix:///var/run/docker.sock
      # AWS configuration
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./scripts/localstack-init.sh:/etc/localstack/init/ready.d/init.sh"  # Auto-init on ready
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # BFF Service
  bff:
    build:
      context: ./bff
    container_name: bff
    ports:
      - "8000:8000"
    environment:
      # Application metadata
      - APP_NAME=BFF Service
      - APP_VERSION=1.0.0
      - LOG_LEVEL=INFO
      # Test Mode - Mock authentication for CI
      - TEST_MODE=true
      - AWS_COGNITO_USER_POOL_ID=us-east-1_cipool
      - AWS_COGNITO_WEB_CLIENT_ID=ciwebclient
      - AWS_COGNITO_MOBILE_CLIENT_ID=cimobileclient
      - AWS_COGNITO_REGION=us-east-1
      # AWS Configuration
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      # LocalStack for S3 and SQS
      - AWS_ENDPOINT_URL=http://localstack:4566
      - AWS_SQS_ENDPOINT_URL=http://localstack:4566
      # Service URLs (internal docker network)
      - CATALOG_URL=http://catalog:8000
      - CLIENT_URL=http://client:8000
      - DELIVERY_URL=http://delivery:8000
      - INVENTORY_URL=http://inventory:8000
      - ORDER_URL=http://order:8000
      - SELLER_URL=http://seller:8000
      # SQS Configuration - LocalStack
      - SQS_QUEUE_URL=http://localstack:4566/000000000000/reports-queue
      - SQS_REPORTS_QUEUE_URL=http://localstack:4566/000000000000/reports-queue
      - SQS_REGION=us-east-1
      - AWS_SQS_ENDPOINT_URL=http://localstack:4566
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/bff/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Catalog Migration
  catalog-migrate:
    build:
      context: ./catalog
      target: migrate
    container_name: catalog-migrate
    environment:
      - DATABASE_URL=postgresql://postgres:password@catalog-db:5432/catalog
    depends_on:
      catalog-db:
        condition: service_healthy
    networks:
      - microservices
    restart: "no"

  # Catalog Service
  catalog:
    build:
      context: ./catalog
      target: app
    container_name: catalog
    ports:
      - "8001:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@catalog-db:5432/catalog
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
      # LocalStack configuration (if catalog uses AWS)
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
    depends_on:
      catalog-migrate:
        condition: service_completed_successfully
      localstack:
        condition: service_healthy
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/catalog/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  catalog-db:
    image: postgres:15-alpine
    container_name: catalog-db
    environment:
      - POSTGRES_DB=catalog
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    tmpfs:
      - /var/lib/postgresql/data  # Use tmpfs for faster CI performance
    networks:
      - microservices
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d catalog"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Client Migration
  client-migrate:
    build:
      context: ./client
      target: migrate
    container_name: client-migrate
    environment:
      - DATABASE_URL=postgresql://postgres:password@client-db:5432/client
    depends_on:
      client-db:
        condition: service_healthy
    networks:
      - microservices
    restart: "no"

  # Client Service
  client:
    build:
      context: ./client
      target: app
    container_name: client
    ports:
      - "8002:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@client-db:5432/client
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
    depends_on:
      client-migrate:
        condition: service_completed_successfully
      localstack:
        condition: service_healthy
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/client/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  client-db:
    image: postgres:15-alpine
    container_name: client-db
    environment:
      - POSTGRES_DB=client
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    tmpfs:
      - /var/lib/postgresql/data
    networks:
      - microservices
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d client"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Delivery Migration
  delivery-migrate:
    build:
      context: ./delivery
      target: migrate
    container_name: delivery-migrate
    environment:
      - DATABASE_URL=postgresql://postgres:password@delivery-db:5432/delivery
    depends_on:
      delivery-db:
        condition: service_healthy
    networks:
      - microservices
    restart: "no"

  # Delivery Service
  delivery:
    build:
      context: ./delivery
      target: app
    container_name: delivery
    ports:
      - "8003:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@delivery-db:5432/delivery
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
    depends_on:
      delivery-migrate:
        condition: service_completed_successfully
      localstack:
        condition: service_healthy
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/delivery/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  delivery-db:
    image: postgres:15-alpine
    container_name: delivery-db
    environment:
      - POSTGRES_DB=delivery
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    tmpfs:
      - /var/lib/postgresql/data
    networks:
      - microservices
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d delivery"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Inventory Migration
  inventory-migrate:
    build:
      context: ./inventory
      target: migrate
    container_name: inventory-migrate
    environment:
      - DATABASE_URL=postgresql://postgres:password@inventory-db:5432/inventory
    depends_on:
      inventory-db:
        condition: service_healthy
    networks:
      - microservices
    restart: "no"

  # Inventory Service
  inventory:
    build:
      context: ./inventory
      target: app
    container_name: inventory
    ports:
      - "8004:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@inventory-db:5432/inventory
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
    depends_on:
      inventory-migrate:
        condition: service_completed_successfully
      localstack:
        condition: service_healthy
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/inventory/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  inventory-db:
    image: postgres:15-alpine
    container_name: inventory-db
    environment:
      - POSTGRES_DB=inventory
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    tmpfs:
      - /var/lib/postgresql/data
    networks:
      - microservices
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d inventory"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Order Migration
  order-migrate:
    build:
      context: ./order
      target: migrate
    container_name: order-migrate
    environment:
      - DATABASE_URL=postgresql://postgres:password@order-db:5432/order
    depends_on:
      order-db:
        condition: service_healthy
    networks:
      - microservices
    restart: "no"

  # Order Service
  order:
    build:
      context: ./order
      target: app
    container_name: order
    ports:
      - "8005:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@order-db:5432/order
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
      # Order service uses S3 and SQS
      - AWS_REGION=us-east-1
      - S3_ORDER_REPORTS_BUCKET=reports-bucket
      - SQS_REPORTS_QUEUE_URL=http://localstack:4566/000000000000/reports-queue
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
    depends_on:
      order-migrate:
        condition: service_completed_successfully
      localstack:
        condition: service_healthy
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/order/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  order-db:
    image: postgres:15-alpine
    container_name: order-db
    environment:
      - POSTGRES_DB=order
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    tmpfs:
      - /var/lib/postgresql/data
    networks:
      - microservices
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d order"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Seller Migration
  seller-migrate:
    build:
      context: ./seller
      target: migrate
    container_name: seller-migrate
    environment:
      - DATABASE_URL=postgresql://postgres:password@seller-db:5432/seller
    depends_on:
      seller-db:
        condition: service_healthy
    networks:
      - microservices
    restart: "no"

  # Seller Service
  seller:
    build:
      context: ./seller
      target: app
    container_name: seller
    ports:
      - "8006:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@seller-db:5432/seller
      - DEBUG_SQL=false
      - LOG_LEVEL=INFO
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
    depends_on:
      seller-migrate:
        condition: service_completed_successfully
      localstack:
        condition: service_healthy
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/seller/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  seller-db:
    image: postgres:15-alpine
    container_name: seller-db
    environment:
      - POSTGRES_DB=seller
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    tmpfs:
      - /var/lib/postgresql/data
    networks:
      - microservices
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d seller"]
      interval: 5s
      timeout: 5s
      retries: 5
