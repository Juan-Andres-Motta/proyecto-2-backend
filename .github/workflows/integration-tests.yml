name: Integration Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  AWS_REGION: us-east-1

jobs:
  integration-tests:
    name: Run Integration Tests with LocalStack
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      checks: write
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Newman
        run: npm install -g newman

      - name: Start services with docker-compose.ci.yml
        run: |
          echo "üèóÔ∏è  Building and starting services..."
          docker compose -f docker-compose.ci.yml up -d --build

      - name: Wait for LocalStack to be ready
        run: |
          echo "‚è≥ Waiting for LocalStack to be ready..."
          MAX_RETRIES=60
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if docker compose -f docker-compose.ci.yml ps localstack | grep -q "healthy"; then
              echo "‚úÖ LocalStack is ready!"
              break
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "   Attempt $RETRY_COUNT/$MAX_RETRIES..."
            sleep 2
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "‚ùå LocalStack failed to become healthy"
            docker compose -f docker-compose.ci.yml logs localstack
            exit 1
          fi

      - name: Wait for services to be ready
        run: |
          echo "‚è≥ Waiting for services to initialize..."
          sleep 30

          echo "üîç Checking BFF health..."
          for i in {1..10}; do
            if curl -sf http://localhost:8000/bff/health >/dev/null 2>&1; then
              echo "‚úÖ BFF is healthy"
              break
            fi
            echo "   Attempt $i/10..."
            sleep 3
          done

      - name: Check service status
        run: |
          echo "üìä Service Status:"
          docker compose -f docker-compose.ci.yml ps

      - name: Verify LocalStack resources
        run: |
          echo "üîç Verifying LocalStack resources..."

          # Check SQS Queue
          if docker exec localstack awslocal sqs list-queues | grep -q "reports-queue"; then
            echo "‚úÖ SQS queue available"
          else
            echo "‚ùå SQS queue not found"
            exit 1
          fi

          # Check S3 Bucket
          if docker exec localstack awslocal s3 ls | grep -q "reports-bucket"; then
            echo "‚úÖ S3 bucket available"
          else
            echo "‚ùå S3 bucket not found"
            exit 1
          fi

      - name: Run database migrations
        run: |
          echo "üóÑÔ∏è  Running database migrations..."

          # Run migrations for each service
          for service in catalog client inventory order seller; do
            echo "Running migrations for $service..."
            docker compose -f docker-compose.ci.yml exec -T $service poetry run alembic upgrade head || true
          done

          echo "‚úÖ Migrations completed"

      - name: Verify services are responding
        run: |
          echo "üîç Checking service health..."

          # Check BFF
          if curl -sf http://localhost:8000/bff/health >/dev/null 2>&1 || curl -sf http://localhost:8000/bff/docs >/dev/null 2>&1; then
            echo "‚úÖ BFF is responding"
          else
            echo "‚ö†Ô∏è  BFF health check failed (may not have health endpoint)"
          fi

          # Give services a moment more
          sleep 5

      - name: Run Newman integration tests
        id: newman_tests
        run: |
          echo "üß™ Running integration tests..."

          newman run MediSupply_BFF_Complete.postman_collection.json \
            -e MediSupply_Local.postman_environment.json \
            --reporters cli,json,junit \
            --reporter-json-export test-results.json \
            --reporter-junit-export test-results.xml \
            --color on \
            --bail || echo "TEST_FAILED=true" >> $GITHUB_ENV

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            test-results.json
            test-results.xml
          retention-days: 30

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: test-results.xml
          check_name: Integration Test Results
          comment_mode: off

      - name: Display service logs on failure
        if: failure()
        run: |
          echo "üìã Displaying service logs..."
          echo ""
          echo "=== BFF Logs ==="
          docker compose -f docker-compose.ci.yml logs --tail=100 bff || true
          echo ""
          echo "=== Catalog Logs ==="
          docker compose -f docker-compose.ci.yml logs --tail=100 catalog || true
          echo ""
          echo "=== Order Logs ==="
          docker compose -f docker-compose.ci.yml logs --tail=100 order || true
          echo ""
          echo "=== LocalStack Logs ==="
          docker compose -f docker-compose.ci.yml logs --tail=100 localstack || true

      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up..."
          docker compose -f docker-compose.ci.yml down -v

      - name: Check for test failures
        if: env.TEST_FAILED == 'true'
        run: |
          echo "‚ùå Integration tests failed"
          exit 1
